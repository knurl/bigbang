registryCredentials:
  enabled: true
  registry: {{HelmRegistry}}
  username: {{HelmRepoUser}}
  password: {{HelmRepoPassword}}

starburstPlatformLicense: {{license}}

# How the starburst service will be exposed.
expose:
  {% if IngressLoadBalancer %}
  type: "ingress"
  ingress:
    tls:
      enabled: true
    host: {{StarburstHost}}
    {% if Target == "gcs" %}
    path: "/*"
    {% endif %}
    {% if Target == "aws" %}
    annotations:
      kubernetes.io/ingress.class: nginx
    {% elif Target == "gcp" %}
    gcpBackendConfig:
      name: hc-config
      url: /v1/info
      port: 8080
    annotations:
      kubernetes.io/ingress.class: "gce-internal"
      kubernetes.io/ingress.regional-static-ip-name: {{starburst_address_name}}
      kubernetes.io/ingress.allow-http: "false"
    {% endif %}
  {% else %}
  type: loadBalancer
  loadBalancer:
    # NOTE AWS doesn't support specifying a static IP address for LBs
    {% if Target != "aws" %}
    IP: {{starburst_address | string}}
    {% endif %}
    ports:
      {% if RequireInternalTls or RequireCoordTls %}
      https:
        port: 8443
      http: null
      {% else %}
      http:
        port: 8080
      https: null
      {% endif %}
    annotations:
      {% if Target == "aws" %}
      service.beta.kubernetes.io/aws-load-balancer-internal: "true"
      {% elif Target == "az" %}
      service.beta.kubernetes.io/azure-load-balancer-internal: "true"
      {% elif Target == "gcp" %}
      networking.gke.io/load-balancer-type: "Internal"
      {% endif %}
  {% endif %}

{% if RequireInternalTls %}
# Shared secret for internal communication.
sharedSecret: secretRef:{{sharedsec}}:{{sharedsecbf}}

# Use only https and port 8443 for internal communication.
internal:
  ports:
    https:
      port: 8443
    http: null
{% endif %}

coordinator:
  etcFiles:
    properties:
      config.properties: |
        coordinator=true
        node-scheduler.include-coordinator=false
        #        colocated-joins-enabled=true
        #        data-product.starburst-user=starburst_service
        #        data-product.starburst-password=test
        #        starburst.data-product.enabled=true
        http-server.http.port=8080
        http-server.authentication.type=PASSWORD,DELEGATED-PASSWORD
        {% if IngressLoadBalancer %}
        # These two have to be here because (i) we need to accept headers from
        # the LB promising us that the channel prior to the LB was encrypted,
        # and (ii) because between the LB and Starburst, the communications
        # will include passwords but will be in the clear.
        http-server.process-forwarded=true
        http-server.authentication.allow-insecure-over-http=true
        {% endif %}
        task.writer-count = 8
        {% if RequireInternalTls %}
        # TLS everywhere
        http-server.http.enabled=false
        http-server.https.enabled=true
        http-server.https.port=8443
        # Coordinator cert does have localhost, so https OK
        discovery.uri=https://localhost:8443
        {% elif RequireCoordTls %}
        # TLS for coordinator only
        http-server.http.enabled=true
        http-server.https.enabled=true
        http-server.https.port=8443
        # Coordinator cert doesn't have localhost, so can't use https
        discovery.uri=http://localhost:8080
        {% else %}
        # Not using TLS from coordinator (might be TLS to LB though)
        http-server.http.enabled=true
        http-server.https.enabled=false
        discovery.uri=http://localhost:8080
        {% endif %}
        {% if RequireInternalTls %}
        http-server.https.keystore.path=secretRef:{{wildks}}:{{wildksbf}}
        http-server.https.keystore.key={{KeystorePass}}
        {% elif RequireCoordTls %}
        http-server.https.keystore.path=secretRef:{{starburstks}}:{{starburstksbf}}
        http-server.https.keystore.key={{KeystorePass}}
        {% endif %}
        {% if RequireInternalTls %}
        node.internal-address-source=FQDN
        internal-communication.https.required=true
        internal-communication.https.keystore.path=secretRef:{{wildks}}:{{wildksbf}}
        internal-communication.https.keystore.key={{KeystorePass}}
        internal-communication.https.truststore.path=secretRef:{{wildks}}:{{wildksbf}}
        internal-communication.https.truststore.key={{KeystorePass}}
        {% endif %}
        insights.persistence-enabled=true
        insights.metrics-persistence-enabled=true
        insights.jdbc.url=jdbc:postgresql://{{evtlog_address}}:{{postgres_port}}/{{DBNameEventLogger}}
        insights.jdbc.user={{evtlog_user}}
        insights.jdbc.password={{DBPassword}}
        insights.metrics-collection-interval=15s
        insights.metrics-persistence-interval=60s
        insights.authorized-users=.*
      {% if AuthNLdap %}
      password-authenticator.properties: |
        password-authenticator.name=ldap
        ldap.url={{LdapUri}}
        ldap.bind-dn=cn=admin,dc=az,dc=starburstdata,dc=net
        ldap.bind-password=admin
        ldap.group-auth-pattern=(&(objectClass=inetOrgPerson)(uid=${USER}))
        ldap.user-base-dn=ou=People,dc=az,dc=starburstdata,dc=net
        ldap.user-bind-pattern=uid=${USER},ou=People,dc=az,dc=starburstdata,dc=net
      {% endif %}
      access-control.properties: |
        access-control.name=ranger
        ranger.authentication-type=BASIC
        ranger.username=starburst_service
        ranger.password=RangerPassword1
        ranger.service-name=starburst-enterprise
        ranger.policy-rest-url=http://ranger:6080
        ranger.policy-refresh-interval=10s
  resources:
    requests:
      memory: {{coordinator_mem}}
      cpu: {{coordinator_cpu}}
    limits:
      memory: {{coordinator_mem}}
      cpu: {{coordinator_cpu}}

worker:
  replicas: {{workerCount}}
  resources:
    requests:
      memory: {{worker_mem}}
      cpu: {{worker_cpu}}
    limits:
      memory: {{worker_mem}}
      cpu: {{worker_cpu}}
  etcFiles:
    properties:
      config.properties: |
        coordinator=false
        {% if not RequireInternalTls %}
        # TLS on coordinator only, or no TLS
        # In this case our cert doesn't include the coordinator service name as
        # a SAN, which means we'll get a host mismatch when we try to connect.
        # Therefore in this case we'll have to leave port 8080 open and have
        # the workers connect there.
        discovery.uri=http://coordinator.starburst.svc:8080
        {% else %}
        # TLS everywhere
        # The cert _does_ include a SAN for the coordinator service name
        discovery.uri=https://coordinator.starburst.svc:8443
        {% endif %}
        {% if not RequireInternalTls %}
        http-server.http.enabled=true
        http-server.http.port=8080
        {% else %}
        # When enabling TLS for internal communication don't set node.internal-address since
        # it'll be set automatically to <pod-ip>.worker.<namespace>.svc.
        # Add DNS:starburst, DNS:coordinator.<namespace>.svc and DNS:*.worker.<namespace>.svc as SAN in your certs
        http-server.http.enabled=false
        http-server.https.enabled=true
        http-server.https.port=8443
        http-server.https.keystore.path=secretRef:{{wildks}}:{{wildksbf}}
        http-server.https.keystore.key={{KeystorePass}}
        node.internal-address-source=FQDN
        internal-communication.https.required=true
        internal-communication.https.keystore.path=secretRef:{{wildks}}:{{wildksbf}}
        internal-communication.https.keystore.key={{KeystorePass}}
        internal-communication.https.truststore.path=secretRef:{{wildks}}:{{wildksbf}}
        internal-communication.https.truststore.key={{KeystorePass}}
        {% endif %}

{% if not AuthNLdap %}
# If we're not going to be using LDAP, then automatically switch over to using
# a password database ("file"). Note that just adding userDatabase here
# automatically enables the password authenticator.
userDatabase:
  enabled: true
  users:
    - username: {{TrinoUser}}
      password: {{TrinoPass}}
    - username: alice
      password: {{TrinoPass}}
    - username: bob
      password: {{TrinoPass}}
    - username: carol
      password: {{TrinoPass}}
{% endif %}

{% if RequireInternalTls %}
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - curl -k --max-time 5 -s https://localhost:8443/v1/info | grep \"starting\":false

livenessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - curl -k --max-time 5 -s https://localhost:8443/v1/info | grep \"starting\":false
{% endif %}

catalogs:
  {{ HiveCat }}: |
    connector.name=hive
    hive.metastore.uri=thrift://hive:9083
    hive.security=allow-all
    {% if Target == "az" %}
    hive.azure.abfs-storage-account={{StorageAccount}}
    hive.azure.abfs-access-key={{adls_access_key}}
    {% elif Target == "gcp" %}
    hive.gcs.json-key-file-path=secretRef:{{gcskey}}:{{gcskeybf}}
    hive.gcs.use-access-token=false
    {% endif %}
  sfdc: |
    connector.name=salesforce
    salesforce.user={{SalesforceUser}}
    salesforce.password={{SalesforcePassword}}
    salesforce.security-token={{SalesforceSecurityToken}}
  {% if Target == "aws" %}
  delta: |
    connector.name=delta-lake
    hive.metastore=glue
    hive.metastore.glue.pin-client-to-current-region=true
    hive.security=allow-all
    delta.hide-non-delta-lake-tables=true
  {% if not DisableSlowSources %}
  redshift: |
    connector.name=redshift
    connection-url=jdbc:redshift://{{redshift_endpoint}}/{{DBName}}
    connection-user={{redshift_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  {% endif %}
  {% elif Target == "az" %}
  {% if not DisableSlowSources %}
  synapse_sl: |
    connector.name=synapse
    connection-url=jdbc:sqlserver://{{synapse_sl_address}}:1433;database=master
    connection-user={{synapse_sl_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  synapse_pool: |
    connector.name=synapse
    connection-url=jdbc:sqlserver://{{synapse_pool_address}}:1433;database={{DBName}}
    connection-user={{synapse_pool_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  {% endif %}
  {% elif Target == "gcp" %}
  bq: |
    connector.name=bigquery
    bigquery.project-id={{ GcpProjectId | string }}
  {% endif %}
  mysql: |
    connector.name=mysql
    connection-url=jdbc:mysql://{{mysql_address}}:{{mysql_port}}/?serverTimezone=UTC
    connection-user={{mysql_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  postgresql: |
    connector.name=postgresql
    connection-url=jdbc:postgresql://{{postgres_address}}:{{postgres_port}}/{{DBName}}
    connection-user={{postgres_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  {% if UpstreamSG %}
  sg_az_adls: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionAzPort}}/adls
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_az_mysql: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionAzPort}}/mysql
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_az_postgresql: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionAzPort}}/postgresql
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_az_synapse: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionAzPort}}/synapse
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_gcp_gcs: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionGcpPort}}/gcs
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_gcp_mysql: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionGcpPort}}/mysql
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_gcp_postgresql: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionGcpPort}}/postgresql
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  sg_gcp_bq: |
    connector.name=stargate
    connection-url=jdbc:trino://{{StarburstHost}}:{{BastionGcpPort}}/bq
    connection-user={{TrinoUser}}
    connection-password={{TrinoPass}}
    ssl.enabled=true
  {% endif %}
