registryCredentials:
  enabled: true
  registry: {{HelmRegistry}}
  username: {{HelmRepoUser}}
  password: {{HelmRepoPassword}}

starburstPlatformLicense: {{LicenseName}}

# How the starburst service will be exposed.
expose:
  type: loadBalancer
  loadBalancer:
  {% if RequireInternalTls or RequireCoordTls %}
    ports:
      https:
        port: 8443
      http: null
  {% endif %}
    annotations:
      {% if target == "aws" %}
      service.beta.kubernetes.io/aws-load-balancer-internal: "true"
      {% elif target == "az" %}
      service.beta.kubernetes.io/azure-load-balancer-internal: "true"
      {% elif target == "gcp" %}
      networking.gke.io/load-balancer-type: "Internal"
      {% endif %}

{% if RequireInternalTls %}
# Shared secret for internal communication.
sharedSecret: secretRef.sharedsecret.sharedsecret

# Use only https and port 8443 for internal communication.
internal:
  ports:
    https:
      port: 8443
    http: null
{% endif %}

coordinator:
  etcFiles:
    properties:
      config.properties: |
        coordinator=true
        node-scheduler.include-coordinator=false
        http-server.http.port=8080
        discovery-server.enabled=true
        # allow access to non-ssl for demo purposes
        exchange.http-client.max-connections=5000
        exchange.http-client.max-connections-per-server=5000
        scheduler.http-client.max-connections=5000
        scheduler.http-client.max-requests-queued-per-destination=5000
        scheduler.http-client.max-connections-per-server=5000
        http-server.authentication.type=PASSWORD,DELEGATED-PASSWORD
        # TLS everywhere
        {% if RequireInternalTls %}
        http-server.http.enabled=false
        http-server.https.enabled=true
        http-server.https.port=8443
        # Coordinator cert does have localhost, so https OK
        discovery.uri=https://localhost:8443
        # TLS for coordinator only
        {% elif RequireCoordTls %}
        http-server.http.enabled=true
        http-server.https.enabled=true
        http-server.https.port=8443
        # Coordinator cert doesn't have localhost, so can't use https
        discovery.uri=http://localhost:8080
        # No TLS anywhere
        {% else %}
        http-server.http.enabled=true
        http-server.https.enabled=false
        discovery.uri=http://localhost:8080
        {% endif %}
        {% if RequireInternalTls %}
        http-server.https.keystore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        http-server.https.keystore.key=test123
        {% elif RequireCoordTls %}
        http-server.https.keystore.path=secretRef:presto.pkcs12:presto.pkcs12
        http-server.https.keystore.key=test123
        {% endif %}
        {% if RequireInternalTls %}
        node.internal-address-source=FQDN
        internal-communication.https.required=true
        internal-communication.https.keystore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        internal-communication.https.keystore.key=test123
        internal-communication.https.truststore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        internal-communication.https.truststore.key=test123
        {% endif %}
        insights.persistence-enabled=true
        insights.metrics-persistence-enabled=true
        insights.jdbc.url=jdbc:postgresql://{{evtlog_address}}:{{postgres_port}}/{{DBNameEventLogger}}
        insights.jdbc.user={{evtlog_user}}
        insights.jdbc.password={{DBPassword}}
        insights.metrics-collection-interval=15s
        insights.metrics-persistence-interval=60s
        insights.authorized-users=.*
      event-listener.properties: |
        event-listener.name=event-logger
        jdbc.url=jdbc:postgresql://{{evtlog_address}}:{{postgres_port}}/{{DBNameEventLogger}}
        jdbc.user={{evtlog_user}}
        jdbc.password={{DBPassword}}
      access-control.properties: |
        access-control.name=ranger
        ranger.authentication-type=BASIC
        ranger.username=presto_service
        ranger.password=RangerPassword1
        ranger.service-name=starburst-enterprise-presto
        ranger.policy-rest-url=http://ranger:6080
        ranger.policy-refresh-interval=10s
  resources:
    requests:
      memory: {{coordinator_mem}}
      cpu: {{coordinator_cpu}}
    limits:
      memory: {{coordinator_mem}}
      cpu: {{coordinator_cpu}}

worker:
  replicas: {{workerCount}}
  resources:
    requests:
      memory: {{worker_mem}}
      cpu: {{worker_cpu}}
    limits:
      memory: {{worker_mem}}
      cpu: {{worker_cpu}}
  etcFiles:
    properties:
      config.properties: |
        exchange.http-client.max-connections=5000
        exchange.http-client.max-connections-per-server=5000
        coordinator=false
        # TLS on coordinator only, or no TLS
        {% if not RequireInternalTls %}
        # If we are using TLS on the coordinator only, then our cert doesn't
        # include the coordinator service name as a SAN, which means we'll get a
        # host mismatch when we try to connect. Therefore in this case we'll
        # have to leave port 8080 open and have the workers connect there.
        discovery.uri=http://coordinator.starburst.svc:8080
        # TLS everywhere
        {% else %}
        # The cert _does_ include a SAN for the coordinator service name
        discovery.uri=https://coordinator.starburst.svc:8443
        {% endif %}
        {% if not RequireInternalTls %}
        http-server.http.enabled=true
        http-server.http.port=8080
        {% else %}
        # When enabling TLS for internal communication don't set node.internal-address since
        # it'll be set automatically to <pod-ip>.worker.<namespace>.svc.
        # Add DNS:starburst, DNS:coordinator.<namespace>.svc and DNS:*.worker.<namespace>.svc as SAN in your certs
        http-server.http.enabled=false
        http-server.https.enabled=true
        http-server.https.port=8443
        http-server.https.keystore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        http-server.https.keystore.key=test123
        node.internal-address-source=FQDN
        internal-communication.https.required=true
        internal-communication.https.keystore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        internal-communication.https.keystore.key=test123
        internal-communication.https.truststore.path=secretRef:starburst.svc.p12:starburst.svc.p12
        internal-communication.https.truststore.key=test123
        {% endif %}

# How many queries per node
query:
  maxConcurrentQueries: 200

# It's handy to have the certificate in the containers as well
extraSecret:
  name: presto.pem
  file: presto.pem

# automatically enables password authenticator
userDatabase:
  enabled: true
  users:
    - username: {{TrinoUser}}
      password: {{TrinoPass}}

{% if RequireInternalTls %}
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - curl -k --max-time 5 -s https://localhost:8443/v1/info | grep \"starting\":false

livenessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - curl -k --max-time 5 -s https://localhost:8443/v1/info | grep \"starting\":false
{% endif %}

catalogs:
  hive: |
    connector.name=hive-hadoop2
    hive.metastore.uri=thrift://hive:9083
    hive.non-managed-table-creates-enabled=true
    hive.non-managed-table-writes-enabled=true
    hive.security=allow-all
    hive.file-status-cache-tables=*
    hive.file-status-cache-expire-time=60m
{% if target == "az" %}
    hive.azure.abfs-storage-account={{StorageAccount}}
    hive.azure.abfs-access-key={{adls_access_key}}
{% elif target == "gcp" %}
    hive.gcs.json-key-file-path=secretRef:{{gcskeyname}}:{{gskeyfbn}}
    hive.gcs.use-access-token=false
  bigquery: |
    connector.name=bigquery
    bigquery.project-id={{bq_project_id}}
{% endif %}
  mysql: |
    connector.name=mysql
    connection-url=jdbc:mysql://{{mysql_address}}:{{mysql_port}}/
    connection-user={{mysql_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  postgresql: |
    connector.name=postgresql
    connection-url=jdbc:postgresql://{{postgres_address}}:{{postgres_port}}/{{DBName}}
    connection-user={{postgres_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  postgresqlel: |
    connector.name=postgresql
    connection-url=jdbc:postgresql://{{evtlog_address}}:{{postgres_port}}/{{DBNameEventLogger}}
    connection-user={{evtlog_user}}
    connection-password={{DBPassword}}
    allow-drop-table=true
  remote_hive: |
    connector.name=starburst-remote
    connection-url=jdbc:presto://{{PrestoHost}}:{{PrestoPort}}/hive
    connection-user={{TrinoUser}}
    {% if RequireCoordTls %}
    connection-password={{TrinoPass}}
    ssl.enabled=true
    {% else %}
    ssl.enabled=false
    {% endif %}
  remote_postgresql: |
    connector.name=starburst-remote
    connection-url=jdbc:presto://{{PrestoHost}}:{{PrestoPort}}/postgresql
    connection-user={{TrinoUser}}
    {% if RequireCoordTls %}
    connection-password={{TrinoPass}}
    ssl.enabled=true
    {% else %}
    ssl.enabled=false
    {% endif %}
  remote_mysql: |
    connector.name=starburst-remote
    connection-url=jdbc:presto://{{PrestoHost}}:{{PrestoPort}}/mysql
    connection-user={{TrinoUser}}
    {% if RequireCoordTls %}
    connection-password={{TrinoPass}}
    ssl.enabled=true
    {% else %}
    ssl.enabled=false
    {% endif %}
